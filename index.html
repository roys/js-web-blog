<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#673AB7">
  <title>My blog - blog.roysolberg.com</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
  <link type="text/css" rel="stylesheet" href="https://cdn.rawgit.com/roys/js-web-blog/4c063477/css/materialize.min.css" />
  <link type="text/css" rel="stylesheet" href="https://cdn.rawgit.com/roys/js-web-blog/4c063477/css/jqcloud.min.css" />
  <link type="text/css" rel="stylesheet" href="https://rawgit.com/roys/js-web-blog/master/css/blog.css" />
  <link type="text/css" rel="stylesheet" href="css/blog.css" />
  <script type="text/javascript" src="https://rawgit.com/roys/js-web-blog/master/contents.js"></script>
  <script type="text/javascript" src="contents.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.2/knockout-min.js"></script>
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="https://cdn.rawgit.com/roys/js-web-blog/4c063477/js/materialize.min.js"></script>
  <script type="text/javascript" src="https://cdn.rawgit.com/roys/js-web-blog/4c063477/js/jqcloud.min.js"></script>
  <script type="text/javascript" src="js/viewmodels.js"></script>
  <script>
    // ## Primary: #673AB7
    // TODO: Implement 404 page in this page
    window.SpaBlog = window.SpaBlog || {}; // Our namespace
    window.SpaBlog.config = {
      trackerId: 'UA-392774-21',
      blogUrlPrefix: '/blog'
    }

    $(function () {
      ko.bindingHandlers.fadeVisible = {
        init: function (element, valueAccessor) {
          console.log('init():' + element);
          // Initially set the element to be instantly visible/hidden depending on the value
          var value = valueAccessor();
          $(element).toggle(ko.unwrap(value)); // Use "unwrapObservable" so we can handle values that may or may not be observable
        },
        update: function (element, valueAccessor) {
          console.log('update():' + element);
          // Whenever the value subsequently changes, slowly fade the element in or out
          var value = valueAccessor();
          ko.unwrap(value) ? $(element).fadeIn('fast') : $(element).fadeOut('fast');
        }
      };
      var posts = SpaBlog.posts;
      var categories = [];
      var tags = [];
      posts.forEach(function (post) {
        if (post.category) {
          categories.forEach(function (category, index) {
            if (post.category.title === category.title) {
              categories.splice(index, 1);
            }
          });
          categories.push(post.category);
        }
        if (post.tags) {
          post.tags.forEach(function (postTag, index) {
            var foundTag = false;
            tags.forEach(function (existingTag, index) {
              if (!foundTag && postTag.title === existingTag.text) {
                existingTag.weight = existingTag.weight + 1;
                foundTag = true;
              }
            });
            if (!foundTag) {
              tags.push({
                text: postTag.title, handlers: {
                  click: function () {
                    goToTag(postTag);
                    return false;
                  }
                }, weight: 1, link: window.SpaBlog.config.blogUrlPrefix + '/tag' + postTag.url
              });
            }
          });
        }
      }, this);
      categories.sort(function (a, b) {
        if (a.title < b.title)
          return -1;
        if (a.title > b.title)
          return 1;
        return 0;
      });

      function AppViewModel() {
        console.log('AppViewModel()');
        this.posts = posts;
        this.categories = categories;
        this.post = ko.observable();
        this.category = ko.observable();
        this.tag = ko.observable();
        this.isTransitioning = ko.observable(true);
        this.shouldDisplayFrontpage = ko.computed(function () {
          console.log('shouldDisplayFrontpage: return ' + !this.post());
          return !this.isTransitioning() && !this.post() && !this.category() && !this.tag();
        }, this);
        this.shouldDisplayArticle = ko.computed(function () {
          console.log('shouldDisplayArticle()');
          return !this.isTransitioning() && this.post();
        }, this);
        this.shouldDisplayCategory = ko.computed(function () {
          console.log('shouldDisplayCategory()');
          return !this.isTransitioning() && this.category();
        }, this);
        this.shouldDisplayTag = ko.computed(function () {
          console.log('shouldDisplayTag()');
          return !this.isTransitioning() && this.tag();
        }, this);
      };
      window.contentViewModel = new AppViewModel();
      window.contentViewModel.tags = tags;
      ko.applyBindings(window.contentViewModel);

      var path = location.protocol === 'file:' ? location.hash : location.pathname
      var index = path.indexOf(window.SpaBlog.config.blogUrlPrefix);
      if (index !== -1) {
        path = path.substr(index + window.SpaBlog.config.blogUrlPrefix.length);
      }
      if (path.startsWith('/')) {
        path = path.substr(1);
      }
      if (path.endsWith('/')) {
        path = path.substr(0, path.length - 1);
      }
      //alert(path);
      var parts = path.split('/');
      console.log(parts);
      if (parts.length === 2) {
        if (parts[0] === 'category') {
          var categoryUrl = '/' + parts[1];
          var foundCategory = false;
          categories.forEach(function (category, index) {
            console.log(category);
            if (!foundCategory && category.url === categoryUrl) {
              foundCategory = true;
              goToCategory(category);
            }
          });
          if (!foundCategory) {
            // TODO: 404
          }
        } else if (parts[0] === 'tag') {
          var tagUrl = window.SpaBlog.config.blogUrlPrefix + '/tag/' + parts[1];
          console.log('tagUrl:' + tagUrl);
          var foundTag = false;
          tags.forEach(function (tag, index) {
            console.log(tag);
            if (!foundTag && tag.link === tagUrl) {
              foundTag = true;
              goToTag({ title: tag.text, url: tag.link });
            }
          });
          if (!foundTag) {
            // TODO: 404
          }
        }
      } else if (parts.length === 3) { // Post
        var niceUrl = '/' + path;
        var foundPost = false;
        posts.forEach(function (post, index) {
          console.log(post);
          if (!foundPost && post.niceUrl === niceUrl) {
            foundPost = true;
            goToPost(post);
          }
        });
        if (!foundPost) {
          // TODO: 404
        }
      } else {
        // TODO: 404
      }
    });
    function goToFrontpage() {
      if (changeUrl(null, 'My blog', '/')) {
        window.contentViewModel.post(null);
        window.contentViewModel.tag(null);
        window.contentViewModel.category(null);
        window.contentViewModel.isTransitioning(false);
        console.log($('#tag-cloud'));
        $('#tag-cloud').jQCloud(window.contentViewModel.tags, {
          autoResize: true,
          delay: 350,
          colors: ['#311B92', '#4527A01', '#512DA8', '#5E35B1', '#673AB7', '#7E57C2', '#9575CD', '#B39DDB', '#D1C4E9'],//, '#EDE7F6'],
          fontSize: ['36px', '33px', '30px', '27px', '24px', '21px', '18px', '15px', '12px']
        });
      }
    }
    function goToPost(post) {
      if (changeUrl(null, post.title, post.niceUrl)) {
        window.contentViewModel.isTransitioning(true);
        setTimeout(function () {
          window.contentViewModel.post(post);
          window.contentViewModel.tag(null);
          window.contentViewModel.category(null);
          window.contentViewModel.isTransitioning(false);
        }, 250);
      }
    }
    function goToCategory(category) {
      if (changeUrl(null, category.title, '/category' + category.url)) {
        window.contentViewModel.isTransitioning(true);
        setTimeout(function () {
          window.contentViewModel.post(null);
          window.contentViewModel.tag(null);
          window.contentViewModel.category(category);
          window.contentViewModel.isTransitioning(false);
        }, 250);
      }
    }
    function goToTag(tag) {
      console.log(tag);
      if (changeUrl(null, tag.title, '/tag' + tag.url)) {
        window.contentViewModel.isTransitioning(true);
        setTimeout(function () {
          window.contentViewModel.post(null);
          window.contentViewModel.tag(tag);
          window.contentViewModel.category(null);
          window.contentViewModel.isTransitioning(false);
        }, 250);
      }
    }
    function changeUrl(state, title, url) {
      url = window.SpaBlog.config.blogUrlPrefix + url;
      console.log('changeUrl()', url);
      try {
        history.pushState(state, title, url)
        // If push state throws an exception the page view will automatically be logged on next page load
        ga('set', {
          page: url,
          title: title
        });
        ga('send', 'pageview');
        return true;
      } catch (e) {
        if (location.protocol !== 'file:') {
          console.error(e);
          location.href = url;
          return false;
        } else {
          location.href = '#' + url;
          return true;
        }
      }
    }
    window.onpopstate = function (event) {
      console.log('***');
      console.log("onpopstate() location: " + document.location + ", state: " + JSON.stringify(event.state));
      console.log(event);
      console.log('*******');
    };
  </script>
</head>

<body>
  <script>
    (function (i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date(); a = s.createElement(o),
        m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

    ga('create', window.SpaBlog.config.trackerId, 'auto');
    ga('send', 'pageview');
  </script>
  <nav>
    <div class="nav-wrapper">
      <div class="container">
        <!-- a href="/blog/" class="brand-logo left" data-bind="click: function(){goToFrontpage()}">My blog</a -->
        <ul id="nav-mobile" class="left">
          <li><a data-bind="attr: { href: window.SpaBlog.config.blogUrlPrefix }, click: function(){goToFrontpage()}">blog.roysolberg.com</a></li>
        </ul>
      </div>
    </div>
  </nav>
  <div id="frontpage" style="display: none" class="container" data-bind="template: { name: 'frontpage-template', if: !$data.post()}, fadeVisible: $data.shouldDisplayFrontpage">
  </div>
  <div id="article" style="display: none" class="container" data-bind="template: { name: 'article-template', if: $data.post}, fadeVisible: $data.shouldDisplayArticle">
  </div>
  <div id="category" style="display: none" class="container" data-bind="template: { name: 'category-template', if: $data.category}, fadeVisible: $data.shouldDisplayCategory">
  </div>
  <div id="tag" style="display: none" class="container" data-bind="template: { name: 'tag-template', if: $data.tag}, fadeVisible: $data.shouldDisplayTag">
  </div>
  <footer id="footer" style="display: none" class="page-footer" data-bind="visible: true, fadeVisible: !$data.isTransitioning()">
    <div class="footer-copyright">
      <div class="container">
        <a class="grey-text text-lighten-4" href="http://roysolberg.com/">Â© 2017 Roy Solberg</a>
        <a class="grey-text text-lighten-4 right" href="https://github.com/roys/js-web-blog">GitHub project</a>
      </div>
    </div>
  </footer>
  <script>
    /**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    var disqus_config = function () {
      this.page.url = 'http://blog.roysolberg.com';  // Replace PAGE_URL with your page's canonical URL variable
      //this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };

    (function () { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://roysolberg.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      //(d.head || d.body).appendChild(s);
    })();
  </script>
  <script type="text/html" id="frontpage-template">
    <h4>Latest posts</h4>
    <div class="row" data-bind="foreach: {data: posts, as: 'post'}">
      <div class="col s12 m6 l4 xl3">
        <div class="card">
          <div class="card-content waves-effect" data-bind="click: function(){goToPost(post)}">
            <span class="card-title" data-bind="text: post.title"></span>
            <p data-bind="text: post.summary"></p>
          </div>
          <div class="card-action">
            <a href="#" data-bind="attr: { href: post.niceUrl}, click: function(){goToPost(post)}">Read more</a>
          </div>
        </div>
        <a href="#" data-bind="attr: { href: post.niceUrl}"></a>
      </div>
    </div>
    <h4>Categories</h4>
    <div class="row">
      <div class="col s12 m6 l4">
        <div class="collection" data-bind="foreach: {data: categories, as: 'category'}">
          <a href="#" class="collection-item" data-bind="attr: { href: category.url}, text: category.title, click: function(){goToCategory(category)}">Category</a>
        </div>
      </div>
    </div>
    <!--
    <div class="row" data-bind="foreach: {data: categories, as: 'category'}">
      <div class="col s12 m3 l4">
        <div class="card">
          <div class="card-content waves-effect" data-bind="click: function(){goToCategory(category)}">
            <span class="card-title" data-bind="text: category.title"></span>
          </div>
        </div>
        <a href="#" data-bind="attr: { href: category.url}"></a>
      </div>
    </div>
    -->
    <h4>Tags</h4>
    <div class="row">
      <div id="tag-cloud" class="col s12 m8 l6" style="height:150px;"></div>
    </div>
    <div id="disqus_thread"></div>
  </script>

  <script type="text/html" id="article-template">
    <div style="margin-bottom:0px;" class="row">
      <div class="col s12">
        <h3 data-bind="text: post().title">Article</h3>
      </div>
    </div>
    <div class="row">
      <div class="col s12">
        <p class="flow-text"><b data-bind="html: post().summary"></b></p>
      </div>
    </div>
    <table class="article grey-text">
      <tr data-bind="with: post().publishDate">
        <td style="width:5%;" class="">Published:</td>
        <td data-bind="text: new Date($data).toLocaleString([], {weekday: 'short', year: 'numeric', month: 'long', day: '2-digit', hour: '2-digit', minute: '2-digit'})">
        </td>
      </tr>
      <tr data-bind="with: post().category">
        <td style="width:5%">Category:</td>
        <td>
          <a href="#" data-bind="attr: { href: url}, click: function(){goToCategory($data)}">
            <div class="chip" data-bind="text: title"></div>
          </a>
        </td>
      </tr>
      <tr data-bind="with: post().tags">
        <td style="width:5%">Tags:</td>
        <td>
          <!-- ko foreach: {data: $data, as: 'tag'} -->
          <a href="#" data-bind="attr: { href: tag.url }, click: function(){goToTag(tag)}">
            <div class="chip" data-bind="text: tag.title"></div>
          </a>
          <!-- /ko -->
        </td>
      </tr>
    </table>
    <div class="row">
      <div class="col s12">
        <p style="white-space: pre-wrap;" class="flow-text" data-bind="html: post().text"></p>
      </div>
    </div>
    <div id="disqus_thread"></div>
  </script>

  <script type="text/html" id="category-template">
    <div style="margin-bottom:0px;" class="row">
      <div class="col s12">
        <h3 data-bind="text: category().title">Category</h3>
        <p>Showing all articles in category.</p>
      </div>
    </div>
    <div class="row" data-bind="foreach: {data: posts, as: 'post'}">
      <!-- ko if: post.category && $parent.category().title === post.category.title -->
      <div class="col s12 m6 l4 xl3">
        <div class="card">
          <div class="card-content waves-effect" data-bind="click: function(){goToPost(post)}">
            <span class="card-title" data-bind="text: post.title"></span>
            <p data-bind="text: post.summary"></p>
          </div>
          <div class="card-action">
            <a href="#" data-bind="attr: { href: post.niceUrl}, click: function(){goToPost(post)}">Read more</a>
          </div>
        </div>
        <a href="#" data-bind="attr: { href: post.niceUrl}"></a>
      </div>
      <!-- /ko -->
  </script>

  <script type="text/html" id="tag-template">
    <div style="margin-bottom:0px;" class="row">
      <div class="col s12">
        <h3 data-bind="text: tag().title">Tag</h3>
        <p>Showing all articles with selected tag.</p>
      </div>
    </div>
    <div class="row" data-bind="foreach: {data: posts, as: 'post'}">
      <!-- ko foreach: {data: post.tags, as: 'tag'} -->
      <!-- ko if: $root.tag().title === tag.title -->
      <div class="col s12 m6 l4 xl3">
        <div class="card">
          <div class="card-content waves-effect" data-bind="click: function(){goToPost(post)}">
            <span class="card-title" data-bind="text: post.title"></span>
            <p data-bind="text: post.summary"></p>
          </div>
          <div class="card-action">
            <a href="#" data-bind="attr: { href: post.niceUrl}, click: function(){goToPost(post)}">Read more</a>
          </div>
        </div>
        <a href="#" data-bind="attr: { href: post.niceUrl}"></a>
      </div>
      <!-- /ko -->
      <!-- /ko -->
  </script>
</body>

</html>